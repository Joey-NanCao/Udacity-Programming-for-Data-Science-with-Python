/* Query #1 */
WITH t1 AS (
    SELECT *
    FROM
        category c
        JOIN film_category fc ON c.category_id = fc.category_id
        JOIN film f ON f.film_id = fc.film_id
    WHERE c.name IN ('Animation', 'Children','Classics','Comedy','Family','Music')
)
SELECT
    t1.title, t1.name, t1.rental_duration,
    NTILE(4)
    OVER (
      ORDER BY
          rental_duration) AS standard_quartile
FROM
     t1
ORDER BY
     standard_quartile

/* Query #2 */
SELECT
    DATE_PART('month', r1.rental_date) AS rental_month,
    DATE_PART('year', r1.rental_date) AS rental_year,
    ('Store ' || s1.store_id) AS store,
    COUNT(*)
FROM
    store AS s1
    JOIN staff AS s2 ON s1.store_id = s2.store_id
		JOIN rental r1 ON s2.staff_id = r1.staff_id
 GROUP BY
    1, 2, 3
 ORDER BY
    2, 1;

/* Query #3 */
WITH t1 AS (
    SELECT
        (first_name || ' ' || last_name) AS name,
        c.customer_id,
        p.amount,
        p.payment_date
    FROM
        customer AS c
        JOIN payment AS p ON c.customer_id = p.customer_id),
t2 AS (
    SELECT
        t1.customer_id
    FROM
        t1
    GROUP BY
        1
    ORDER BY
        SUM(t1.amount)
        DESC
    LIMIT 10)
SELECT
    t1.name,
    DATE_PART('month', t1.payment_date) AS payment_month,
    DATE_PART('year', t1.payment_date) AS payment_year,
    COUNT (*),
    SUM(t1.amount)
FROM
    t1
    JOIN t2 ON t1.customer_id = t2.customer_id
 WHERE
    t1.payment_date BETWEEN '20070101' AND '20080101'
 GROUP BY
    1, 2, 3;

/* Query 4 */
WITH t1 AS (
    SELECT
        (first_name || ' ' || last_name) AS name,
        c.customer_id,
        p.amount,
        p.payment_date
    FROM
        customer AS c
        JOIN payment AS p ON c.customer_id = p.customer_id),
t2 AS (
    SELECT
        t1.customer_id
    FROM
        t1
    GROUP BY
        1
    ORDER BY
        SUM(t1.amount)
        DESC
    LIMIT 10),
t3 AS (
    SELECT
        t1.name,
        DATE_TRUNC('month', t1.payment_date) AS pay_mon,
        COUNT(*) AS pay_countpermon,
        SUM(t1.amount) AS pay_amount
    FROM
        t1
        JOIN t2 ON t1.customer_id = t2.customer_id
    WHERE
        t1.payment_date BETWEEN '20070101' AND '20080101'
    GROUP BY
        1, 2
    ORDER BY
        1, 3, 2
)
SELECT
    t3.name,
    t3.pay_mon,
    t3.pay_amount,
	  ROUND(AVG(t3.pay_amount)
    OVER (PARTITION BY
             t3.name), 2) AS avg_amount
FROM
    t3
ORDER BY
    1, 2;
